<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vixem Home</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Welcome to Vixem</h1>
    <p id="userInfo">Loading user...</p>

    <!-- GROUPS SECTION -->
    <h2>Groups</h2>
    <form id="createGroupForm">
      <input type="text" id="groupName" placeholder="Group Name" required>
      <button type="submit">Create Group</button>
    </form>
    <ul id="groupsList"></ul>

    <!-- GAMES SECTION -->
    <h2>Games</h2>
    <form id="createGameForm">
      <input type="text" id="gameName" placeholder="Game Name" required>
      <textarea id="gameDescription" placeholder="Description"></textarea>
      <label>Thumbnail: <input type="file" id="gameThumbnail" accept="image/png"></label>
      <label>Icon: <input type="file" id="gameIcon" accept="image/png"></label>
      <button type="submit">Create Game</button>
    </form>
    <ul id="gamesList"></ul>
  </div>

  <footer>© 2025 Vixem</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCga58FAppW68zxbVuPNPCiTsnqX4YzN4U",
      authDomain: "vixem-5c2e1.firebaseapp.com",
      projectId: "vixem-5c2e1",
      storageBucket: "vixem-5c2e1.firebasestorage.app",
      messagingSenderId: "107703363696",
      appId: "1:107703363696:web:a2171648c5221bedc6ecb5",
      measurementId: "G-2EH3SV2YDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const userInfo = document.getElementById("userInfo");
    const groupsList = document.getElementById("groupsList");
    const gamesList = document.getElementById("gamesList");

    // Display user info
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          const data = snap.data();
          userInfo.innerText = `${data.username} — Vixdust: ${data.vixdust ?? 0}`;
        }
        loadGroups();
        loadGames();
      } else {
        userInfo.innerText = "Not signed in";
      }
    });

    // Create group
    document.getElementById("createGroupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      const name = document.getElementById("groupName").value;
      await addDoc(collection(db, "groups"), {
        name,
        owner: user.uid,
        members: [user.uid],
        posts: []
      });
      loadGroups();
    });

    // Load groups
    async function loadGroups() {
      groupsList.innerHTML = "";
      const querySnap = await getDocs(collection(db, "groups"));
      querySnap.forEach((docSnap) => {
        const g = docSnap.data();
        const li = document.createElement("li");
        li.innerHTML = `
          <h3>${g.name}</h3>
          <p>Members: ${g.members?.length || 0}</p>
          <p>Owner: ${g.owner}</p>
          <button data-id="${docSnap.id}" class="joinGroup">Join Group</button>
        `;
        groupsList.appendChild(li);
      });

      document.querySelectorAll(".joinGroup").forEach(btn => {
        btn.onclick = async () => {
          const user = auth.currentUser;
          const groupRef = doc(db, "groups", btn.dataset.id);
          await updateDoc(groupRef, { members: arrayUnion(user.uid) });
          loadGroups();
        };
      });
    }

    // Create game
    document.getElementById("createGameForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      const name = document.getElementById("gameName").value;
      const desc = document.getElementById("gameDescription").value;

      // Upload thumbnail & icon
      const thumbFile = document.getElementById("gameThumbnail").files[0];
      const iconFile = document.getElementById("gameIcon").files[0];

      let thumbURL = "", iconURL = "";
      if (thumbFile) {
        const refThumb = ref(storage, "games/thumbnails/" + thumbFile.name);
        await uploadBytes(refThumb, thumbFile);
        thumbURL = await getDownloadURL(refThumb);
      }
      if (iconFile) {
        const refIcon = ref(storage, "games/icons/" + iconFile.name);
        await uploadBytes(refIcon, iconFile);
        iconURL = await getDownloadURL(refIcon);
      }

      await addDoc(collection(db, "games"), {
        name, desc,
        thumbnail: thumbURL,
        icon: iconURL,
        likes: 0,
        dislikes: 0,
        owner: user.uid,
        gamepasses: []
      });
      loadGames();
    });

    // Load games
    async function loadGames() {
      gamesList.innerHTML = "";
      const querySnap = await getDocs(collection(db, "games"));
      querySnap.forEach((docSnap) => {
        const g = docSnap.data();
        const li = document.createElement("li");
        li.innerHTML = `
          <h3>${g.name}</h3>
          <p>${g.desc}</p>
          ${g.thumbnail ? `<img src="${g.thumbnail}" alt="Thumbnail" style="max-width:100%;">` : ""}
          ${g.icon ? `<img src="${g.icon}" alt="Icon" style="width:50px;height:50px;">` : ""}
          <p>Likes: ${g.likes} | Dislikes: ${g.dislikes}</p>
          <p>Owner: ${g.owner}</p>
          <button data-id="${docSnap.id}" class="likeGame">👍</button>
          <button data-id="${docSnap.id}" class="dislikeGame">👎</button>
        `;
        gamesList.appendChild(li);
      });

      document.querySelectorAll(".likeGame").forEach(btn => {
        btn.onclick = async () => {
          const refGame = doc(db, "games", btn.dataset.id);
          await updateDoc(refGame, { likes: increment(1) });
          loadGames();
        };
      });

      document.querySelectorAll(".dislikeGame").forEach(btn => {
        btn.onclick = async () => {
          const refGame = doc(db, "games", btn.dataset.id);
          await updateDoc(refGame, { dislikes: increment(1) });
          loadGames();
        };
      });
    }
  </script>
</body>
</html>
