<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home - Vixem</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="container">
    <h1 id="welcome">Welcome!</h1>
    <p id="vixdust">Loading your balance...</p>
    <div class="button-group">
      <button id="logout-btn">Logout</button>
    </div>

    <hr>

    <!-- Groups -->
    <section>
      <h2>Create a Group</h2>
      <input id="group-name" placeholder="Group Name">
      <button id="create-group-btn">Create Group</button>
      <p id="group-status"></p>
    </section>

    <hr>

    <!-- Games -->
    <section>
      <h2>Create a Game</h2>
      <input id="game-name" placeholder="Game Name"><br>
      <textarea id="game-desc" placeholder="Game Description"></textarea><br>
      <label>Thumbnail: <input type="file" id="game-thumb" accept="image/png"></label><br>
      <label>Icon: <input type="file" id="game-icon" accept="image/png"></label><br>
      <button id="create-game-btn">Create Game</button>
      <p id="game-status"></p>
    </section>
  </main>

  <!-- Firebase Modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-storage.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyCga58FAppW68zxbVuPNPCiTsnqX4YzN4U",
      authDomain: "vixem-5c2e1.firebaseapp.com",
      projectId: "vixem-5c2e1",
      storageBucket: "vixem-5c2e1.firebasestorage.app",
      messagingSenderId: "107703363696",
      appId: "1:107703363696:web:a2171648c5221bedc6ecb5",
      measurementId: "G-2EH3SV2YDB"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elements
    const welcomeEl = document.getElementById("welcome");
    const vixdustEl = document.getElementById("vixdust");
    const logoutBtn = document.getElementById("logout-btn");

    const groupNameEl = document.getElementById("group-name");
    const groupStatusEl = document.getElementById("group-status");
    const createGroupBtn = document.getElementById("create-group-btn");

    const gameNameEl = document.getElementById("game-name");
    const gameDescEl = document.getElementById("game-desc");
    const gameThumbEl = document.getElementById("game-thumb");
    const gameIconEl = document.getElementById("game-icon");
    const gameStatusEl = document.getElementById("game-status");
    const createGameBtn = document.getElementById("create-game-btn");

    let currentUser = null;

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          welcomeEl.textContent = `Welcome, ${data.username}!`;
          vixdustEl.textContent = `üíé Vixdust: ${data.vixdust}`;
        }
      } else {
        window.location.href = "login.html";
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Create Group
    createGroupBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const name = groupNameEl.value.trim();
      if (!name) {
        groupStatusEl.textContent = "‚ùå Please enter a group name.";
        return;
      }
      try {
        await addDoc(collection(db, "groups"), {
          name,
          owner: currentUser.uid,
          members: [currentUser.uid],
          createdAt: serverTimestamp()
        });
        groupStatusEl.textContent = "‚úÖ Group created successfully!";
        groupNameEl.value = "";
      } catch (err) {
        console.error(err);
        groupStatusEl.textContent = "‚ùå Error: " + err.message;
      }
    });

    // Create Game
    createGameBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const name = gameNameEl.value.trim();
      const desc = gameDescEl.value.trim();
      if (!name) {
        gameStatusEl.textContent = "‚ùå Please enter a game name.";
        return;
      }

      try {
        let thumbUrl = "";
        let iconUrl = "";

        if (gameThumbEl.files.length > 0) {
          const thumbFile = gameThumbEl.files[0];
          const thumbRef = ref(storage, `games/${currentUser.uid}/thumb_${Date.now()}.png`);
          await uploadBytes(thumbRef, thumbFile);
          thumbUrl = await getDownloadURL(thumbRef);
        }

        if (gameIconEl.files.length > 0) {
          const iconFile = gameIconEl.files[0];
          const iconRef = ref(storage, `games/${currentUser.uid}/icon_${Date.now()}.png`);
          await uploadBytes(iconRef, iconFile);
          iconUrl = await getDownloadURL(iconRef);
        }

        await addDoc(collection(db, "games"), {
          name,
          description: desc,
          owner: currentUser.uid,
          thumbnail: thumbUrl,
          icon: iconUrl,
          createdAt: serverTimestamp()
        });

        gameStatusEl.textContent = "‚úÖ Game created successfully!";
        gameNameEl.value = "";
        gameDescEl.value = "";
        gameThumbEl.value = "";
        gameIconEl.value = "";
      } catch (err) {
        console.error(err);
        gameStatusEl.textContent = "‚ùå Error: " + err.message;
      }
    });
  </script>
</body>
</html>
